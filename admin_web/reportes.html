<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reportes de Asistencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/bootstrap-material-design.min.css">
  <link rel="stylesheet" href="css/all.css">
  <link rel="stylesheet" href="css/jquery.mCustomScrollbar.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.7/css/dataTables.dataTables.min.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Syne:wght@700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary:       #0ea5e9;
      --primary-dark:  #0284c7;
      --primary-light: #e0f2fe;
      --success:       #10b981;
      --success-dark:  #059669;
      --danger:        #ef4444;
      --warning:       #f59e0b;
      --purple:        #8b5cf6;
      --purple-light:  #ede9fe;
      --bg:            #f1f5f9;
      --surface:       #ffffff;
      --border:        #e2e8f0;
      --text:          #1e293b;
      --muted:         #94a3b8;
      --radius:        14px;
      --shadow:        0 4px 24px rgba(0,0,0,0.07);
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      height: 100%; overflow: hidden;
      font-family: 'DM Sans', sans-serif;
      background: var(--bg); color: var(--text);
    }

    .main-container { height: 100vh; display: flex; }
    .page-content { flex: 1; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background: var(--bg); }

    .full-box.navbar-info {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0 20px; height: 52px; display: flex; align-items: center; justify-content: space-between;
    }

    .page-header-custom { padding: 18px 24px 10px; }
    .page-header-custom h3 { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; color: var(--text); margin: 0 0 2px; }
    .page-header-custom p { font-size: 13px; color: var(--muted); margin: 0; }

    .scroll-area { flex: 1; overflow-y: auto; padding: 0 24px 30px; }
    .scroll-area::-webkit-scrollbar { width: 6px; }
    .scroll-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

    /* NAV TABS */
    .nav-tabs-custom { display: flex; gap: 8px; margin-bottom: 20px; padding-top: 4px; flex-wrap: wrap; }
    .nav-tab-btn {
      display: inline-flex; align-items: center; gap: 8px; padding: 9px 18px;
      border-radius: 10px; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif;
      text-decoration: none; transition: all .2s; border: 1.5px solid var(--border);
      background: var(--surface); color: var(--muted);
    }
    .nav-tab-btn:hover { color: var(--primary); border-color: var(--primary); text-decoration: none; }
    .nav-tab-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 14px rgba(14,165,233,.3); }

    /* KPI CARDS */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
    @media (max-width: 768px) { .kpi-grid { grid-template-columns: repeat(2,1fr); } }

    .kpi-card {
      background: var(--surface); border-radius: var(--radius); border: 1.5px solid var(--border);
      padding: 16px 20px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 14px;
      animation: fadeUp .35s ease both;
    }
    .kpi-card:nth-child(2) { animation-delay: .06s; }
    .kpi-card:nth-child(3) { animation-delay: .12s; }
    .kpi-card:nth-child(4) { animation-delay: .18s; }

    .kpi-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .kpi-icon.blue   { background: var(--primary-light); color: var(--primary); }
    .kpi-icon.green  { background: #d1fae5; color: var(--success); }
    .kpi-icon.amber  { background: #fef3c7; color: var(--warning); }
    .kpi-icon.purple { background: var(--purple-light); color: var(--purple); }

    .kpi-label { font-size: 11px; font-weight: 600; color: var(--muted); letter-spacing: .05em; text-transform: uppercase; margin-bottom: 2px; }
    .kpi-value { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; color: var(--text); }

    /* FILTER CARD */
    .filter-card {
      background: var(--surface); border-radius: var(--radius); border: 1.5px solid var(--border);
      margin-bottom: 16px; overflow: hidden; box-shadow: var(--shadow); animation: fadeUp .35s ease both;
    }
    .filter-card-header { display: flex; align-items: center; gap: 10px; padding: 14px 20px; border-bottom: 1.5px solid var(--border); background: #fafbfc; }
    .filter-card-body { padding: 16px 20px; }

    .icon-box { width: 34px; height: 34px; border-radius: 9px; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0; }
    .icon-box.amber { background: #fef3c7; color: var(--warning); }
    .filter-card-header h6 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; margin: 0; color: var(--text); }
    .filter-card-header small { font-size: 12px; color: var(--muted); display: block; }

    .filters-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; align-items: end; }
    @media (max-width: 992px) { .filters-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 576px) { .filters-grid { grid-template-columns: 1fr; } }

    .field-group { margin: 0; }
    .field-group label { font-size: 11px; font-weight: 600; color: var(--muted); letter-spacing: .05em; text-transform: uppercase; display: block; margin-bottom: 6px; }
    .field-group input,
    .field-group select {
      width: 100%; height: 42px; border: 1.5px solid var(--border); border-radius: 10px;
      padding: 0 14px; font-size: 14px; font-family: 'DM Sans', sans-serif;
      color: var(--text); background: var(--surface);
      transition: border-color .2s, box-shadow .2s; outline: none; appearance: none;
    }
    .field-group input:focus,
    .field-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(14,165,233,.12); }

    .btn-filter {
      display: inline-flex; align-items: center; justify-content: center; gap: 7px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff; border: none; border-radius: 10px; height: 42px; padding: 0 20px;
      font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif;
      cursor: pointer; transition: transform .15s, box-shadow .2s;
      box-shadow: 0 4px 14px rgba(14,165,233,.35); width: 100%;
    }
    .btn-filter:hover { transform: translateY(-1px); }
    .btn-filter:disabled { opacity: .6; cursor: not-allowed; transform: none; }

    .btn-clear {
      display: inline-flex; align-items: center; justify-content: center; gap: 7px;
      background: transparent; color: var(--muted); border: 1.5px solid var(--border);
      border-radius: 10px; height: 42px; padding: 0 20px;
      font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif;
      cursor: pointer; transition: border-color .2s, color .2s; width: 100%;
    }
    .btn-clear:hover { border-color: var(--muted); color: var(--text); }

    /* LIST CARD */
    .list-card {
      background: var(--surface); border-radius: var(--radius); border: 1.5px solid var(--border);
      overflow: hidden; box-shadow: var(--shadow); animation: fadeUp .4s ease both; animation-delay: .1s;
    }
    .list-card-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; border-bottom: 1.5px solid var(--border); background: #fafbfc; }
    .list-card-header-left { display: flex; align-items: center; gap: 10px; }
    .list-card-header h6 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; margin: 0; color: var(--text); }
    .list-card-header small { font-size: 12px; color: var(--muted); display: block; }
    .list-card-body { padding: 16px 20px; }

    .btn-csv {
      display: inline-flex; align-items: center; gap: 7px;
      background: var(--success); color: #fff; border: none; border-radius: 9px; padding: 8px 16px;
      font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif;
      cursor: pointer; transition: background .2s, transform .15s;
      box-shadow: 0 3px 10px rgba(16,185,129,.3);
    }
    .btn-csv:hover { background: var(--success-dark); transform: translateY(-1px); }

    /* TABLE */
    #tablaReportes { width: 100%; border-collapse: collapse; font-size: 13px; }
    #tablaReportes thead th {
      background: #1e293b !important; color: #fff !important;
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 11px;
      letter-spacing: .06em; text-transform: uppercase; padding: 11px 14px;
      text-align: center; border: none !important;
    }
    #tablaReportes thead th:first-child { border-radius: 8px 0 0 8px; }
    #tablaReportes thead th:last-child  { border-radius: 0 8px 8px 0; }
    #tablaReportes tbody tr { border-bottom: 1px solid var(--border); transition: background .15s; }
    #tablaReportes tbody tr:hover { background: #f8fafc; }
    #tablaReportes tbody td { padding: 10px 14px; vertical-align: middle; text-align: center; color: var(--text); }

    /* BADGES */
    .fecha-badge { display: inline-flex; align-items: center; gap: 5px; background: var(--primary-light); color: var(--primary); border-radius: 20px; padding: 3px 10px; font-size: 12px; font-weight: 600; }
    .hora-badge  { display: inline-flex; align-items: center; gap: 5px; background: #d1fae5; color: var(--success); border-radius: 20px; padding: 3px 10px; font-size: 12px; font-weight: 600; }
    .hora-badge.salida { background: #fef3c7; color: var(--warning); }
    .tipo-diaria { display: inline-flex; align-items: center; gap: 5px; background: #d1fae5; color: #065f46; border-radius: 20px; padding: 3px 10px; font-size: 12px; font-weight: 700; }
    .tipo-evento { display: inline-flex; align-items: center; gap: 5px; background: var(--purple-light); color: #5b21b6; border-radius: 20px; padding: 3px 10px; font-size: 12px; font-weight: 700; }
    .dur-badge   { background: #f1f5f9; color: var(--text); border-radius: 8px; padding: 3px 10px; font-size: 12px; font-weight: 600; font-family: monospace; }

    .empty-state { padding: 40px 20px; text-align: center; color: var(--muted); }
    .empty-state i { font-size: 32px; margin-bottom: 10px; display: block; }

    /* DataTables */
    .dataTables_wrapper .dataTables_filter input { border: 1.5px solid var(--border); border-radius: 9px; padding: 6px 12px; font-size: 13px; font-family: 'DM Sans', sans-serif; outline: none; }
    .dataTables_wrapper .dataTables_filter input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(14,165,233,.1); }
    .dataTables_wrapper .dataTables_length select { border: 1.5px solid var(--border); border-radius: 9px; padding: 5px 10px; font-family: 'DM Sans', sans-serif; }
    .dataTables_wrapper .dataTables_paginate .paginate_button { border-radius: 8px !important; font-family: 'DM Sans', sans-serif; font-size: 13px; }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current { background: var(--primary) !important; color: #fff !important; border: none !important; }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover { background: var(--primary-light) !important; color: var(--primary) !important; border: none !important; }

    @keyframes fadeUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    i { transform: none !important; filter: none !important; }

    @media (max-width: 768px) {
      html, body { overflow: auto; }
      .page-content { overflow: auto; height: auto; }
      .scroll-area { overflow: visible; }
    }
  </style>
</head>

<body>
<main class="full-box main-container">

  <section class="full-box nav-lateral">
    <div class="full-box nav-lateral-bg show-nav-lateral"></div>
    <div class="full-box nav-lateral-content">
      <figure class="full-box nav-lateral-avatar">
        <i class="far fa-times-circle show-nav-lateral"></i>
        <img src="assets/avatar/Avatar2.png" class="img-fluid" alt="Avatar">
        <figcaption class="roboto-medium text-center">
          Administrador <br><small class="roboto-condensed-light">Gestión</small>
        </figcaption>
      </figure>
      <nav class="full-box nav-lateral-menu">
        <ul>
          <li><a href="dashboard.html"><i class="fab fa-dashcube fa-fw"></i> &nbsp; Dashboard</a></li>
          <li><a href="empleados-new.html"><i class="fas fa-user-plus fa-fw"></i> &nbsp; Nuevo Empleado</a></li>
          <li><a href="empleados-list.html"><i class="fas fa-users fa-fw"></i> &nbsp; Lista Empleados</a></li>
          <li><a href="eventos-list.html"><i class="fas fa-calendar-plus fa-fw"></i> &nbsp; Eventos</a></li>
          <li><a href="lugares-list.html"><i class="fas fa-map-marked-alt fa-fw"></i> &nbsp; Lugares</a></li>
          <li><a href="notificaciones.html"><i class="fas fa-bell fa-fw"></i> &nbsp; Notificaciones</a></li>
          <li><a class="active" href="reportes.html"><i class="fas fa-file-alt fa-fw"></i> &nbsp; Reportes</a></li>
        </ul>
      </nav>
    </div>
  </section>

  <section class="full-box page-content">
    <nav class="full-box navbar-info">
      <a href="#" class="float-left show-nav-lateral"><i class="fas fa-exchange-alt"></i></a>
      <a href="#" onclick="cerrarSesion()"><i class="fas fa-power-off"></i></a>
    </nav>

    <div class="page-header-custom">
      <h3><i class="fas fa-chart-bar fa-fw"></i> &nbsp; Reportes de Asistencia</h3>
      <p>Filtra por fecha y empleado, revisa entradas/salidas y exporta a CSV.</p>
    </div>

    <div class="scroll-area">

      <!-- KPIs: 4 cards -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-icon blue"><i class="fas fa-list-ol"></i></div>
          <div>
            <div class="kpi-label">Total Registros</div>
            <div class="kpi-value" id="kpi-total">0</div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon green"><i class="fas fa-clock"></i></div>
          <div>
            <div class="kpi-label">Total Horas</div>
            <div class="kpi-value" id="sum-horas">0</div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon amber"><i class="fas fa-hourglass-half"></i></div>
          <div>
            <div class="kpi-label">Minutos</div>
            <div class="kpi-value" id="sum-min">0</div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon purple"><i class="fas fa-stopwatch"></i></div>
          <div>
            <div class="kpi-label">Segundos</div>
            <div class="kpi-value" id="sum-seg">0</div>
          </div>
        </div>
      </div>

      <!-- FILTROS -->
      <div class="filter-card">
        <div class="filter-card-header">
          <div class="icon-box amber"><i class="fas fa-filter"></i></div>
          <div>
            <h6>Filtros</h6>
            <small>Filtra por rango de fechas y empleado</small>
          </div>
        </div>
        <div class="filter-card-body">
          <div class="filters-grid">
            <div class="field-group">
              <label>Desde</label>
              <input type="date" id="desde">
            </div>
            <div class="field-group">
              <label>Hasta</label>
              <input type="date" id="hasta">
            </div>
            <div class="field-group">
              <label>Empleado</label>
              <select id="empleado">
                <option value="">— Todos —</option>
              </select>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
              <button type="button" id="filtrar" class="btn-filter">
                <i class="fas fa-search"></i> Filtrar
              </button>
              <button type="button" id="limpiar" class="btn-clear">
                <i class="fas fa-eraser"></i> Limpiar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- TABLA -->
      <div class="list-card">
        <div class="list-card-header">
          <div class="list-card-header-left">
            <div class="icon-box"><i class="fas fa-table"></i></div>
            <div>
              <h6>Registros de Asistencia</h6>
              <small id="total-registros">Cargando...</small>
            </div>
          </div>
          <button id="csv" class="btn-csv">
            <i class="fas fa-file-csv"></i> Exportar CSV
          </button>
        </div>
        <div class="list-card-body">
          <table id="tablaReportes" style="width:100%">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Empleado ID</th>
                <th>Entrada</th>
                <th>Salida</th>
                <th>Evento</th>
                <th>Duración</th>
              </tr>
            </thead>
            <tbody id="tbodyReportes"></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>
</main>

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="js/bootstrap-material-design.min.js"></script>
<script>$(document).ready(() => { $('body').bootstrapMaterialDesign(); });</script>
<script src="js/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.26.20/dist/sweetalert2.all.min.js"></script>
<script src="js/logout.js"></script>
<script src="js/admin-api.js"></script>
<script src="https://cdn.datatables.net/2.3.7/js/dataTables.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const elDesde    = document.getElementById("desde");
  const elHasta    = document.getElementById("hasta");
  const elEmpleado = document.getElementById("empleado");
  const btnFiltrar = document.getElementById("filtrar");
  const btnLimpiar = document.getElementById("limpiar");
  const btnCSV     = document.getElementById("csv");
  const tbody      = document.getElementById("tbodyReportes");
  const totalReg   = document.getElementById("total-registros");
  const kpiTotal   = document.getElementById("kpi-total");
  const sumHoras   = document.getElementById("sum-horas");
  const sumMin     = document.getElementById("sum-min");
  const sumSeg     = document.getElementById("sum-seg");

  let dataTable = null;
  let LAST_ROWS = [];
  let EMPLEADOS = []; // caché para mostrar nombre en tabla

  // ── Helpers ──
  const pad2 = n => String(n).padStart(2, "0");

  // Calcula duración en segundos a partir de dos ISO Date strings
  const durSegISO = (entrada, salida) => {
    if (!entrada || !salida) return null;
    const diff = new Date(salida) - new Date(entrada);
    return diff > 0 ? Math.floor(diff / 1000) : 0;
  };

  const fmtSeconds = total => {
    const s = Math.max(0, Math.floor(total || 0));
    return `${pad2(Math.floor(s / 3600))}:${pad2(Math.floor((s % 3600) / 60))}:${pad2(s % 60)}`;
  };

  // Formatea ISO datetime → "HH:MM:SS"
  const fmtHora = iso => {
    if (!iso) return '—';
    try {
      return new Date(iso).toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    } catch { return iso; }
  };

  // Formatea ISO datetime → "YYYY-MM-DD"
  const fmtFecha = iso => {
    if (!iso) return '—';
    try { return new Date(iso).toISOString().slice(0, 10); }
    catch { return iso; }
  };

  const ymd = d => d.toISOString().slice(0, 10);

  // Nombre del empleado desde caché
  const nombreEmp = id => {
    const e = EMPLEADOS.find(x => Number(x.id) === Number(id));
    return e ? `${e.nombre || ''} ${e.apellido || ''}`.trim() : `ID ${id}`;
  };

  // ── Fechas por defecto (últimos 7 días) ──
  function setDefaultDates() {
    const now = new Date();
    const ini = new Date(now);
    ini.setDate(ini.getDate() - 7);
    elDesde.value = localStorage.getItem('reportes:desde') || ymd(ini);
    elHasta.value = localStorage.getItem('reportes:hasta') || ymd(now);
  }

  function saveFilters() {
    localStorage.setItem('reportes:desde',      elDesde.value    || '');
    localStorage.setItem('reportes:hasta',      elHasta.value    || '');
    localStorage.setItem('reportes:empleadoId', elEmpleado.value || '');
  }

  function buildQS() {
    const qs = new URLSearchParams();
    if (elDesde.value)    qs.set('desde',     elDesde.value);
    if (elHasta.value)    qs.set('hasta',      elHasta.value);
    if (elEmpleado.value) qs.set('empleadoId', elEmpleado.value);
    return qs.toString();
  }

  // ── Cargar empleados ──
  async function cargarEmpleados() {
    try {
      const res  = await fetch("/api/empleados", { headers: authHeaders() });
      EMPLEADOS  = await res.json();
      const selPrev = localStorage.getItem('reportes:empleadoId') || '';
      elEmpleado.innerHTML = `<option value="">— Todos —</option>`;
      [...EMPLEADOS]
        .sort((a, b) => (a.apellido || '').localeCompare(b.apellido || ''))
        .forEach(e => {
          elEmpleado.add(new Option(
            `${e.cedula || e.id} - ${e.nombre || ''} ${e.apellido || ''}`.trim(),
            e.id
          ));
        });
      elEmpleado.value = selPrev;
    } catch (err) { console.warn("No se pudo cargar empleados:", err); }
  }

  // ── Render tabla ──
  // Los campos reales del modelo Asistencia son:
  //   id, empleado_id, eventos_id, empleado_evento_id,
  //   hora_entrada (DATE), hora_salida (DATE), tipo ('diaria'|'evento')
  // Si el backend incluye JOIN, puede venir también:
  //   empleado: { nombre, apellido, cedula }, evento: { titulo }
  function renderTabla(rows) {
    if (dataTable) { dataTable.destroy(); dataTable = null; }
    tbody.innerHTML = '';

    if (!rows.length) {
      tbody.innerHTML = `
        <tr><td colspan="7">
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            No se encontraron registros para los filtros seleccionados.
          </div>
        </td></tr>`;
      totalReg.textContent = 'Sin registros';
      kpiTotal.textContent = '0';
      return;
    }

    rows.forEach(r => {
      // ── Nombre del empleado (con o sin JOIN) ──
      let empleadoNombre;
      if (r.empleado && (r.empleado.nombre || r.empleado.apellido)) {
        empleadoNombre = `${r.empleado.nombre || ''} ${r.empleado.apellido || ''}`.trim();
      } else {
        empleadoNombre = nombreEmp(r.empleado_id);
      }

      // ── Evento (con o sin JOIN) ──
      const eventoTxt = r.evento?.titulo || (r.eventos_id ? `Evento #${r.eventos_id}` : '—');

      // ── Fecha y horas ──
      const fecha      = fmtFecha(r.hora_entrada);
      const horaEnt    = fmtHora(r.hora_entrada);
      const horaSal    = r.hora_salida ? fmtHora(r.hora_salida) : '—';
      const durSeg     = durSegISO(r.hora_entrada, r.hora_salida);

      // ── Tipo badge ──
      const tipoBadge = r.tipo === 'diaria'
        ? `<span class="tipo-diaria"><i class="fas fa-calendar-day"></i> Diaria</span>`
        : `<span class="tipo-evento"><i class="fas fa-calendar-star"></i> Evento</span>`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="fecha-badge"><i class="fas fa-calendar-alt"></i> ${fecha}</span></td>
        <td>${tipoBadge}</td>
        <td><strong>${empleadoNombre}</strong></td>
        <td><span class="hora-badge"><i class="fas fa-sign-in-alt"></i> ${horaEnt}</span></td>
        <td><span class="hora-badge salida"><i class="fas fa-sign-out-alt"></i> ${horaSal}</span></td>
        <td>${eventoTxt}</td>
        <td><span class="dur-badge">${durSeg != null ? fmtSeconds(durSeg) : '—'}</span></td>
      `;
      tbody.appendChild(tr);
    });

    const n = rows.length;
    totalReg.textContent = `${n} registro${n !== 1 ? 's' : ''} encontrado${n !== 1 ? 's' : ''}`;
    kpiTotal.textContent = n;

    dataTable = $('#tablaReportes').DataTable({
      paging: true, searching: true, ordering: true, autoWidth: false,
      language: {
        search: "Buscar:", lengthMenu: "Mostrar _MENU_ registros",
        info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
        paginate: { previous: "Anterior", next: "Siguiente" },
        zeroRecords: "No se encontraron resultados"
      }
    });
  }

  // ── Cargar tabla + KPIs ──
  async function cargarTablaYResumen() {
    saveFilters();
    const qs = buildQS();

    btnFiltrar.disabled = true;
    btnFiltrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Filtrando...';

    // Tabla
    try {
      const res  = await fetch(`/api/asistencias?${qs}`, { headers: authHeaders() });
      const list = await res.json();
      LAST_ROWS  = Array.isArray(list) ? list : (list.data || list.rows || []);
      renderTabla(LAST_ROWS);
    } catch (err) {
      console.error('Error al cargar asistencias:', err);
      LAST_ROWS = [];
      renderTabla([]);
      Swal.fire('Error', 'No se pudieron cargar los reportes.', 'error');
    } finally {
      btnFiltrar.disabled = false;
      btnFiltrar.innerHTML = '<i class="fas fa-search"></i> Filtrar';
    }

    // KPIs de resumen desde /api/asistencias/resumen
    try {
      const res  = await fetch(`/api/asistencias/resumen?${qs}`, { headers: authHeaders() });
      const data = await res.json();
      sumHoras.textContent = data.horas    ?? 0;
      sumMin.textContent   = data.minutos  ?? 0;
      sumSeg.textContent   = data.segundos ?? 0;
    } catch {
      // Si no hay endpoint de resumen, calcular en frontend con los datos ya cargados
      let totalSeg = 0;
      LAST_ROWS.forEach(r => {
        const d = durSegISO(r.hora_entrada, r.hora_salida);
        if (d) totalSeg += d;
      });
      sumHoras.textContent = Math.floor(totalSeg / 3600);
      sumMin.textContent   = Math.floor((totalSeg % 3600) / 60);
      sumSeg.textContent   = totalSeg % 60;
    }
  }

  // ── Exportar CSV ──
  function exportarCSV() {
    if (!LAST_ROWS.length) {
      Swal.fire('Sin datos', 'No hay registros para exportar.', 'warning');
      return;
    }

    const headers = ['Fecha', 'Tipo', 'Empleado', 'Entrada', 'Salida', 'Evento', 'Duración (hh:mm:ss)'];
    const lines   = [headers.join(',')];

    LAST_ROWS.forEach(r => {
      let empNombre;
      if (r.empleado && (r.empleado.nombre || r.empleado.apellido)) {
        empNombre = `${r.empleado.nombre || ''} ${r.empleado.apellido || ''}`.trim();
      } else {
        empNombre = nombreEmp(r.empleado_id);
      }
      const eventoTxt = r.evento?.titulo || (r.eventos_id ? `Evento #${r.eventos_id}` : '');
      const durSeg    = durSegISO(r.hora_entrada, r.hora_salida);

      lines.push([
        fmtFecha(r.hora_entrada),
        r.tipo || '',
        empNombre,
        fmtHora(r.hora_entrada),
        r.hora_salida ? fmtHora(r.hora_salida) : '',
        eventoTxt,
        durSeg != null ? fmtSeconds(durSeg) : ''
      ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));
    });

    const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a    = Object.assign(document.createElement('a'), {
      href: url,
      download: `reporte_asistencias_${new Date().toISOString().slice(0, 10)}.csv`
    });
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  }

  // ── Eventos ──
  btnFiltrar.addEventListener("click", cargarTablaYResumen);
  btnLimpiar.addEventListener("click", () => {
    elDesde.value = '';
    elHasta.value = '';
    elEmpleado.value = '';
    localStorage.removeItem('reportes:desde');
    localStorage.removeItem('reportes:hasta');
    localStorage.removeItem('reportes:empleadoId');
    cargarTablaYResumen();
  });
  btnCSV.addEventListener("click", exportarCSV);

  // ── Init ──
  setDefaultDates();
  await cargarEmpleados();
  await cargarTablaYResumen();
});
</script>
</body>
</html>